import{w as ge,y as Ne,a as n,p as e}from"./chunk-WWGJGFF6-nyOa09Sz.js";import{c as j,B as i}from"./createLucideIcon-DtgM1CL6.js";import{a as u,b as h,B as ve,X as ye,D as G,c as X,d as J,e as K,f as Q,L as V,I as we}from"./api-BhhqYs-Z.js";import{C as W,a as Y,b as Z,c as ee,d as se}from"./card-Df6hLeyZ.js";import{R as be,T as _e,a as Ce,b as ae,c as m,d as Se,e as x}from"./table-BNpnYNON.js";import{C as le,S as Te}from"./save-Zqon43ao.js";import"./index-DwmZqWTl.js";const ke=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]],De=j("circle-alert",ke);const Ie=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]],_=j("circle-x",Ie);const $e=[["path",{d:"M12 6v6l4 2",key:"mmk7yg"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],te=j("clock",$e);const ze=[["path",{d:"M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0",key:"1nclc0"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]],Le=j("eye",ze);const Re=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]],Ee=j("rotate-ccw",Re),b={RUNNING:804,SUCCESS:0,FAILED:805},ne={queued:{label:"队列中",variant:"secondary",icon:te},pending:{label:"排队中",variant:"secondary",icon:te},running:{label:"运行中",variant:"default",icon:h},success:{label:"成功",variant:"default",icon:le},failed:{label:"失败",variant:"destructive",icon:_},cancelled:{label:"已取消",variant:"secondary",icon:_}},Ae=f=>f===b.SUCCESS?"success":f===b.FAILED?"failed":f===b.RUNNING?"running":"pending",Oe=ge(function(){const C=Ne(),[S,re]=n.useState([]),[ce,T]=n.useState(!0),[k,D]=n.useState(!1),[c,I]=n.useState(null),[p,N]=n.useState([]),[ie,$]=n.useState(!1),[l,z]=n.useState(1),[L]=n.useState(20),[R,de]=n.useState(0),[d,oe]=n.useState(0),[me,g]=n.useState(!1),[v,E]=n.useState(""),[A,F]=n.useState(""),[P,q]=n.useState(!1),[B,M]=n.useState(null),[U,H]=n.useState(null),o=n.useCallback(async(s=l,a=!1)=>{try{a?D(!0):T(!0);const t=await u.getTaskList(s,L);re(t.data.items||[]),de(t.data.total||0),oe(t.data.total_pages||0),z(t.data.page||s)}catch(t){console.error("加载任务列表失败:",t.message)}finally{T(!1),D(!1)}},[l,L]),y=s=>{z(s),o(s)},xe=async s=>{I(s),$(!0),N([]);try{const a=await u.getTaskResults(s.id);N(a.data||[])}catch(a){console.error("加载结果失败:",a.message)}finally{$(!1)}},he=()=>{I(null),N([])},ue=async()=>{if(!v.trim()){alert("请输入模板名称");return}if(c){q(!0);try{await u.saveTemplate({name:v,description:A,app_id:c.workflow,nodes:c.nodes_list||[],repeat_count:c.repeat_count}),E(""),F(""),g(!1),alert("模板保存成功！")}catch(s){console.error("保存模板失败:",s.message),alert(`保存模板失败: ${s.message}`)}finally{q(!1)}}},je=async s=>{M(s);try{const a=await u.retryTask(s);alert(`已重试 ${a.data.retry_count} 次失败的执行`),o(l,!0)}catch(a){console.error("重试任务失败:",a.message),alert(`重试失败: ${a.message}`)}finally{M(null)}},fe=async s=>{if(confirm("确定要取消这个任务吗？将会移除所有排队中的执行")){H(s);try{const a=await u.cancelTask(s);alert(`已取消 ${a.data.cancelled_count} 个排队中的执行`),o(l,!0)}catch(a){console.error("取消任务失败:",a.message),alert(`取消失败: ${a.message}`)}finally{H(null)}}},O=n.useCallback(()=>{o(l,!0)},[l,o]);n.useEffect(()=>{o()},[]),n.useEffect(()=>{const s=setInterval(()=>{O()},1e4);return()=>clearInterval(s)},[O]);const pe=({status:s})=>{const{icon:a}=ne[s],t=s==="running"?{className:"w-4 h-4 animate-spin"}:{className:"w-4 h-4"};return e.jsx(a,{...t})};return e.jsxs("div",{className:"container mx-auto py-8 px-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"任务管理"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"查看和管理 AI 任务"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(i,{variant:"outline",onClick:()=>o(l,!0),disabled:k,children:[e.jsx(be,{className:`w-4 h-4 mr-2 ${k?"animate-spin":""}`}),"刷新"]}),e.jsx(i,{onClick:()=>C("/create"),children:"创建任务"})]})]}),e.jsxs(W,{children:[e.jsxs(Y,{children:[e.jsx(Z,{children:"任务列表"}),e.jsxs(ee,{children:["当前共有 ",R," 个任务，每 10 秒自动刷新"]})]}),e.jsxs(se,{children:[ce?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(h,{className:"w-8 h-8 animate-spin text-muted-foreground"})}):S.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(De,{className:"w-12 h-12 mx-auto mb-4 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"暂无任务"}),e.jsx(i,{onClick:()=>C("/create"),children:"创建第一个任务"})]}):e.jsxs(_e,{children:[e.jsx(Ce,{children:e.jsxs(ae,{children:[e.jsx(m,{className:"w-20",children:"ID"}),e.jsx(m,{children:"工作流 ID"}),e.jsx(m,{children:"状态"}),e.jsx(m,{className:"w-32",children:"重复进度"}),e.jsx(m,{className:"w-20",children:"重试"}),e.jsx(m,{children:"创建时间"}),e.jsx(m,{className:"w-24",children:"操作"})]})}),e.jsx(Se,{children:S.map(s=>{const a=Ae(s.status_code),t=ne[a];return e.jsxs(ae,{children:[e.jsx(x,{className:"font-mono text-sm",children:s.id}),e.jsx(x,{className:"font-mono text-sm",children:s.workflow}),e.jsx(x,{children:e.jsxs(ve,{variant:t.variant,className:"flex items-center gap-1 w-fit",children:[e.jsx(pe,{status:a}),t.label]})}),e.jsx(x,{children:e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:s.current_repeat}),e.jsxs("span",{className:"text-muted-foreground",children:[" / ",s.repeat_count]}),s.repeat_count>1&&e.jsx("div",{className:"w-full bg-secondary rounded-full h-1.5 mt-1",children:e.jsx("div",{className:"bg-primary h-1.5 rounded-full transition-all",style:{width:`${s.current_repeat/s.repeat_count*100}%`}})})]})}),e.jsxs(x,{className:"text-sm",children:[s.retries>0&&e.jsxs("span",{className:"text-orange-600",children:[s.retries," 次",s.error_message&&` (${s.error_message.substring(0,20)}...)`]}),s.retries===0&&"-"]}),e.jsx(x,{className:"text-sm text-muted-foreground",children:new Date(s.created_at).toLocaleString("zh-CN")}),e.jsx(x,{children:e.jsxs("div",{className:"flex gap-1",children:[(a==="running"||a==="success"||a==="failed")&&e.jsxs(i,{variant:"ghost",size:"sm",onClick:()=>xe(s),className:"gap-1",children:[e.jsx(Le,{className:"w-4 h-4"}),"查看结果"]}),a==="failed"&&e.jsxs(i,{variant:"ghost",size:"sm",onClick:()=>je(s.id),disabled:B===s.id,className:"gap-1",children:[B===s.id?e.jsx(h,{className:"w-4 h-4 animate-spin"}):e.jsx(Ee,{className:"w-4 h-4"}),"重试"]}),(a==="queued"||a==="pending"||a==="running")&&e.jsxs(i,{variant:"ghost",size:"sm",onClick:()=>fe(s.id),disabled:U===s.id,className:"gap-1 text-destructive hover:text-destructive",children:[U===s.id?e.jsx(h,{className:"w-4 h-4 animate-spin"}):e.jsx(ye,{className:"w-4 h-4"}),"取消"]})]})})]},s.id)})})]}),d>1&&e.jsxs("div",{className:"flex items-center justify-between mt-4 pt-4 border-t",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["共 ",R," 条记录，第 ",l," / ",d," 页"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(i,{variant:"outline",size:"sm",onClick:()=>y(l-1),disabled:l===1,children:"上一页"}),e.jsx("div",{className:"flex items-center gap-1",children:Array.from({length:Math.min(5,d)},(s,a)=>{let t;return d<=5||l<=3?t=a+1:l>=d-2?t=d-4+a:t=l-2+a,e.jsx(i,{variant:l===t?"default":"outline",size:"sm",onClick:()=>y(t),className:"w-9",children:t},t)})}),e.jsx(i,{variant:"outline",size:"sm",onClick:()=>y(l+1),disabled:l===d,children:"下一页"})]})]})]})]}),e.jsx(G,{open:!!c,onOpenChange:he,children:e.jsxs(X,{className:"max-w-3xl max-h-[80vh] overflow-y-auto",children:[e.jsx(J,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(K,{children:["任务结果 - #",c?.id]}),e.jsxs(Q,{children:["工作流 ID: ",c?.workflow]})]}),e.jsxs(i,{variant:"outline",size:"sm",onClick:()=>g(!0),className:"gap-1",children:[e.jsx(Te,{className:"w-4 h-4"}),"保存为模板"]})]})}),ie?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(h,{className:"w-8 h-8 animate-spin text-muted-foreground"})}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-4 text-sm",children:[e.jsxs("span",{className:"font-medium",children:["执行进度: ",c?.current_repeat," / ",c?.repeat_count]}),e.jsxs("span",{className:"text-green-600",children:["成功: ",new Set(p.filter(s=>s.status==="success").map(s=>s.repeat_index)).size," 次"]}),e.jsxs("span",{className:"text-red-600",children:["失败: ",new Set(p.filter(s=>s.status==="failed").map(s=>s.repeat_index)).size," 次"]})]}),p.length>0?Object.entries(p.reduce((s,a)=>(s[a.repeat_index]||(s[a.repeat_index]=[]),s[a.repeat_index].push(a),s),{})).sort(([s],[a])=>parseInt(s)-parseInt(a)).map(([s,a])=>{const t=a[0],w=a.some(r=>r.status==="success");return e.jsxs(W,{className:w?"":"border-destructive",children:[e.jsx(Y,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Z,{className:"text-base flex items-center gap-2",children:[w?e.jsxs(e.Fragment,{children:[e.jsx(le,{className:"w-5 h-5 text-green-600"}),"第 ",s," 次执行成功"]}):e.jsxs(e.Fragment,{children:[e.jsx(_,{className:"w-5 h-5 text-destructive"}),"第 ",s," 次执行失败"]}),a.length>1&&e.jsxs("span",{className:"text-sm font-normal text-muted-foreground",children:["(",a.length," 个文件)"]})]}),e.jsx(ee,{children:new Date(t.created_at).toLocaleString("zh-CN")})]})}),e.jsx(se,{children:w?e.jsx("div",{className:"space-y-4",children:a.map(r=>e.jsxs("div",{className:"space-y-2 p-3 bg-muted rounded-lg",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-sm",children:"文件 URL: "}),e.jsx("a",{href:r.file_url,target:"_blank",rel:"noopener noreferrer",className:"text-xs text-primary hover:underline break-all ml-2",children:r.file_url})]}),r.file_url&&r.file_url.match(/\.(jpg|jpeg|png|gif|webp)$/i)&&e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:r.file_url,alt:`Result ${r.id}`,className:"max-w-full h-auto rounded-md border max-h-48 object-contain"})}),r.file_url&&r.file_url.match(/\.(mp4|webm|ogg)$/i)&&e.jsx("div",{className:"mt-2",children:e.jsx("video",{src:r.file_url,controls:!0,className:"max-w-full h-auto rounded-md border max-h-48"})}),r.file_url&&r.file_url.match(/\.(mp3|wav|ogg)$/i)&&e.jsx("div",{className:"mt-2",children:e.jsx("audio",{src:r.file_url,controls:!0,className:"w-full"})})]},r.id))}):e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"font-medium text-destructive",children:"失败原因:"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:t.error_message})]})})]},s)}):e.jsx("div",{className:"text-center py-12 text-muted-foreground",children:"暂无执行结果"})]})]})}),e.jsx(G,{open:me,onOpenChange:g,children:e.jsxs(X,{children:[e.jsxs(J,{children:[e.jsx(K,{children:"保存为模板"}),e.jsx(Q,{children:"将当前任务配置保存为模板，方便下次快速创建相同任务"})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(V,{htmlFor:"templateName",children:["模板名称 ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(we,{id:"templateName",placeholder:"例如：AI 绘画任务模板",value:v,onChange:s=>E(s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"templateDescription",children:"模板描述"}),e.jsx("textarea",{id:"templateDescription",className:"flex min-h-20 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",placeholder:"简要描述此模板的用途",value:A,onChange:s=>F(s.target.value)})]}),e.jsxs("div",{className:"space-y-1 text-sm text-muted-foreground",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"App ID:"})," ",c?.workflow]}),e.jsxs("p",{children:[e.jsx("strong",{children:"节点数量:"})," ",c?.nodes_list?.length||0]}),e.jsxs("p",{children:[e.jsx("strong",{children:"重复次数:"})," ",c?.repeat_count||1]})]})]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(i,{variant:"outline",onClick:()=>g(!1),children:"取消"}),e.jsx(i,{onClick:ue,disabled:P,children:P?e.jsxs(e.Fragment,{children:[e.jsx(h,{className:"w-4 h-4 mr-2 animate-spin"}),"保存中..."]}):"保存模板"})]})]})})]})});export{Oe as default};
