import{w as K,y as ee,q as ae,a as n,p as e}from"./chunk-WWGJGFF6-nyOa09Sz.js";import{B as u}from"./createLucideIcon-DtgM1CL6.js";import{a as d,L as f,I as p,b as v,B as G,D as se,c as te,d as le,e as ie,f as ne}from"./api-BhhqYs-Z.js";import{C as re,a as de,b as ce,c as oe,d as me}from"./card-Df6hLeyZ.js";import{P as ue}from"./plus-Bi-xtxpj.js";import{S as pe,C as fe}from"./save-Zqon43ao.js";import"./index-DwmZqWTl.js";const Ie=K(function(){const S=ee(),D=ae(),[c,w]=n.useState(""),[A,F]=n.useState(!1),[V,k]=n.useState(!1),[o,y]=n.useState([]),[b,x]=n.useState({}),[E,r]=n.useState(null),[I,h]=n.useState({}),[M,m]=n.useState(null),[C,O]=n.useState(1),[z,$]=n.useState({}),[q,g]=n.useState(!1),[T,B]=n.useState(""),[P,U]=n.useState(""),[_,H]=n.useState(!1);n.useEffect(()=>{const a=D.state?.template;if(a){w(a.appId),y(a.nodes),O(a.repeatCount);const t={};a.nodes.forEach(s=>{if(s.fieldValue!==void 0){const l=`${s.nodeId}_${s.fieldName}`;t[l]=s.fieldValue}}),x(t),L(a.nodes),m(`已加载模板: ${a.name}`),setTimeout(()=>{m(null)},3e3)}},[D.state]);const L=async a=>{const t=[];if(a.forEach(s=>{s.fieldValue&&["IMAGE","AUDIO","VIDEO"].includes(s.fieldType)&&t.push(s.fieldValue)}),t.length!==0)try{const s=await d.getMediaFilesByNames(t),l={};(s.data||[]).forEach(i=>{l[i.runninghubFilename]=i}),$(l)}catch(s){console.error("加载媒体文件信息失败:",s.message)}},X=async()=>{if(!c.trim()){r("请输入 App ID");return}F(!0),r(null),y([]),x({});try{const t=((await d.getAppNodes(c)).data||[]).map(l=>({nodeId:l.nodeId,fieldName:l.fieldName,fieldType:l.fieldType,fieldValue:l.fieldValue,nodeName:l.nodeName||l.fieldName,required:!1}));y(t);const s={};t.forEach(l=>{l.fieldValue!==void 0&&(s[l.nodeId]=l.fieldValue)}),x(s),L(t)}catch(a){r(a.message||"加载失败")}finally{F(!1)}},N=a=>`${a.nodeId}_${a.fieldName}`,j=(a,t)=>{x(s=>({...s,[a]:t}))},J=async(a,t)=>{try{h(l=>({...l,[a]:0}));const s=await d.uploadFile(t,l=>{h(i=>({...i,[a]:l}))});j(a,s.data.fileName),s.data.fileId&&$(l=>({...l,[s.data.fileName]:{id:s.data.fileId,originalName:t.name,fileHash:s.data.fileHash,fileSize:t.size,runninghubFilename:s.data.fileName,mimeType:t.type,uploadCount:1,createdAt:new Date().toISOString()}})),h(l=>({...l,[a]:-1}))}catch(s){r(s.message||"上传失败"),h(l=>({...l,[a]:-2}))}},Q=async a=>{a.preventDefault(),r(null),m(null),k(!0);try{const t=o.map(l=>{const i=N(l);return{nodeId:l.nodeId,fieldName:l.fieldName,fieldType:l.fieldType,fieldValue:b[i]||l.fieldValue}}),s={app_id:c,nodes:t,repeat_count:C};await d.submitTask(s),m("任务提交成功！正在跳转到任务列表..."),setTimeout(()=>{S("/tasks")},1500)}catch(t){r(t.message||"提交失败")}finally{k(!1)}},W=async()=>{if(!T.trim()){r("请输入模板名称");return}if(!c.trim()||o.length===0){r("请先加载应用配置");return}H(!0),r(null);try{const a=o.map(t=>{const s=N(t);return{...t,fieldValue:b[s]||t.fieldValue}});await d.saveTemplate({name:T,description:P,app_id:c,nodes:a,repeat_count:C}),m("模板保存成功！"),g(!1),B(""),U(""),setTimeout(()=>{m(null)},3e3)}catch(a){r(a.message||"保存模板失败")}finally{H(!1)}},Y=a=>{const t=N(a),s=b[t],l=I[t]>=0;if(a.fieldType==="IMAGE"||a.fieldType==="AUDIO"||a.fieldType==="VIDEO"){const i=s?z[s]:null;return e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(p,{type:"file",accept:a.fieldType==="IMAGE"?"image/*":a.fieldType==="AUDIO"?"audio/*":"video/*",onChange:Z=>{const R=Z.target.files?.[0];R&&J(t,R)},disabled:l}),s&&!l&&e.jsxs(G,{variant:"secondary",className:"flex items-center gap-1",children:[e.jsx(fe,{className:"w-3 h-3"}),i?"已加载":"已上传"]})]}),l&&I[t]!==-1&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(v,{className:"w-4 h-4 animate-spin"}),"上传中 ",I[t],"%"]}),i&&e.jsxs("div",{className:"mt-3 p-3 bg-muted rounded-lg space-y-2",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"font-medium",children:"文件信息:"}),e.jsxs("div",{className:"text-muted-foreground",children:["原文件名: ",i.originalName]}),e.jsxs("div",{className:"text-muted-foreground",children:["文件大小: ",(i.fileSize/1024).toFixed(2)," KB"]})]}),a.fieldType==="IMAGE"&&e.jsx("img",{src:d.getMediaFile(i.id),alt:i.originalName,className:"max-w-full h-auto rounded-md border max-h-48 object-contain"}),a.fieldType==="VIDEO"&&e.jsx("video",{src:d.getMediaFile(i.id),controls:!0,className:"max-w-full h-auto rounded-md border max-h-48"}),a.fieldType==="AUDIO"&&e.jsx("audio",{src:d.getMediaFile(i.id),controls:!0,className:"w-full"})]})]})}return a.fieldType==="TEXTAREA"?e.jsx("textarea",{className:"flex min-h-20 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",placeholder:`请输入${a.nodeName}`,value:s||"",onChange:i=>j(t,i.target.value)}):a.fieldType==="NUMBER"?e.jsx(p,{type:"number",placeholder:`请输入${a.nodeName}`,value:s||"",onChange:i=>j(t,i.target.value)}):e.jsx(p,{type:"text",placeholder:`请输入${a.nodeName}`,value:s||"",onChange:i=>j(t,i.target.value)})};return e.jsxs("div",{className:"container mx-auto py-8 px-4 max-w-4xl",children:[e.jsxs(re,{children:[e.jsxs(de,{children:[e.jsx(ce,{children:"创建 AI 任务"}),e.jsx(oe,{children:"输入 App ID，配置节点参数后提交任务"})]}),e.jsx(me,{children:e.jsxs("form",{onSubmit:Q,className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(f,{htmlFor:"appId",children:["App ID ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(p,{id:"appId",placeholder:"请输入 RunningHub AI 应用的 App ID",value:c,onChange:a=>w(a.target.value)}),e.jsxs(u,{type:"button",onClick:X,disabled:A,children:[A?e.jsx(v,{className:"w-4 h-4 animate-spin"}):e.jsx(ue,{className:"w-4 h-4"}),"加载配置"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"repeatCount",children:"重复执行次数"}),e.jsx(p,{id:"repeatCount",type:"number",min:"1",max:"100",placeholder:"任务重复执行次数（默认1次）",value:C,onChange:a=>O(Math.max(1,parseInt(a.target.value)||1))}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"任务将依次执行指定次数，最多支持2个任务并行运行"})]}),E&&e.jsx("div",{className:"p-3 bg-destructive/10 text-destructive rounded-md text-sm",children:E}),M&&e.jsx("div",{className:"p-3 bg-green-500/10 text-green-600 dark:text-green-400 rounded-md text-sm",children:M}),o.length>0&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-sm font-medium",children:"节点参数配置"}),o.map(a=>{const t=N(a);return e.jsxs("div",{className:"space-y-2",children:[e.jsxs(f,{className:"flex items-center gap-2",children:[a.nodeName,e.jsx(G,{variant:"outline",className:"text-xs",children:a.fieldType})]}),Y(a)]},t)})]}),o.length>0&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx(u,{type:"submit",disabled:V,className:"flex-1",children:V?e.jsxs(e.Fragment,{children:[e.jsx(v,{className:"w-4 h-4 mr-2 animate-spin"}),"提交中..."]}):"提交任务"}),e.jsxs(u,{type:"button",variant:"outline",onClick:()=>g(!0),className:"gap-1",children:[e.jsx(pe,{className:"w-4 h-4"}),"保存模板"]}),e.jsx(u,{type:"button",variant:"outline",onClick:()=>S("/templates"),children:"模板列表"})]})]})})]}),e.jsx(se,{open:q,onOpenChange:g,children:e.jsxs(te,{children:[e.jsxs(le,{children:[e.jsx(ie,{children:"保存为模板"}),e.jsx(ne,{children:"保存当前配置为模板，方便下次快速创建任务"})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(f,{htmlFor:"templateName",children:["模板名称 ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(p,{id:"templateName",placeholder:"例如：AI 绘画任务模板",value:T,onChange:a=>B(a.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"templateDescription",children:"模板描述"}),e.jsx("textarea",{id:"templateDescription",className:"flex min-h-20 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",placeholder:"简要描述此模板的用途",value:P,onChange:a=>U(a.target.value)})]})]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(u,{variant:"outline",onClick:()=>g(!1),children:"取消"}),e.jsx(u,{onClick:W,disabled:_,children:_?e.jsxs(e.Fragment,{children:[e.jsx(v,{className:"w-4 h-4 mr-2 animate-spin"}),"保存中..."]}):"保存模板"})]})]})})]})});export{Ie as default};
